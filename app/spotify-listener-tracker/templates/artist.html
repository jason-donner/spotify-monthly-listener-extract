{% extends "base.html" %}
{% block content %}
<div class="content-container">
    {% if artist_info %}
    <div style="max-width:900px;margin:40px auto 0 auto;">
        <div style="display:flex;align-items:center;gap:36px;margin-bottom:32px;padding:24px 32px;background:#232323;border-radius:18px;box-shadow:0 2px 16px rgba(0,0,0,0.10);">
            {% if artist_image_url %}
                <img src="{{ artist_image_url }}" alt="{{ artist_info.name }}" style="width:180px;height:180px;border-radius:50%;box-shadow:0 2px 32px rgba(0,0,0,0.18);background:#232323;object-fit:cover;">
            {% endif %}
            <div style="display:flex;flex-direction:column;justify-content:center;gap:10px;">
                <div style="font-size:2.1em;font-weight:bold;color:#fff;line-height:1.1;">{{ artist_info.name }}</div>
                {% if artist_info.genres %}
                    <div style="color:#1DB954;font-size:1.13em;">
                        <span style="font-weight:600;">Genres:</span>
                        <span style="color:#fff;">{{ artist_info.genres|join(', ') }}</span>
                    </div>
                {% endif %}
                {% if artist_info.followers %}
                    <div style="color:#aaa;font-size:1.08em;">
                        <span style="font-weight:600;color:#1DB954;">Followers:</span>
                        <span style="color:#fff;">{{ "{:,}".format(artist_info.followers) }}</span>
                    </div>
                {% endif %}
                {% if all_time_high %}
                    <div style="color:#ff5ecd;font-size:1.13em;font-weight:600;">
                        <span>All-Time High:</span>
                        <span style="color:#fff;">{{ "{:,}".format(all_time_high.value) }}</span>
                        <span style="color:#aaa;font-size:0.98em;">on {{ all_time_high.date | datetimeformat('%b %d, %Y') }}</span>
                    </div>
                {% endif %}
            </div>
        </div>
        <div style="background:#232323;padding:32px 18px 16px 18px;border-radius:18px;box-shadow:0 2px 16px rgba(0,0,0,0.10);margin-bottom:32px;">
            <canvas id="listenersChart" height="140"></canvas>
        </div>
        <table class="artist-history-table">
            <tr>
                <th>Date</th>
                <th>Change</th>
                <th>% Change</th>
                <th>Monthly Listeners</th>
            </tr>
            {% for row in results %}
            <tr>
                <td>{{ row.date | datetimeformat('%b %d, %Y') }}</td>
                <td>
                    {% if not loop.first %}
                        {% set prev = results[loop.index0 - 1] %}
                        {% set diff = row.monthly_listeners - prev.monthly_listeners %}
                        {% if diff > 0 %}
                            <span style="color:#1DB954;font-weight:bold;">+{{ "{:,}".format(diff) }}</span>
                        {% elif diff < 0 %}
                            <span style="color:#e74c3c;font-weight:bold;">{{ "{:,}".format(diff) }}</span>
                        {% else %}
                            <span style="color:#aaa;">—</span>
                        {% endif %}
                    {% else %}
                        <span style="color:#aaa;">—</span>
                    {% endif %}
                </td>
                <td>
                    {% if not loop.first and prev.monthly_listeners != 0 %}
                        {% set pct = ((row.monthly_listeners - prev.monthly_listeners) / prev.monthly_listeners) * 100 %}
                        {% if pct > 0 %}
                            <span style="color:#1DB954;font-weight:bold;">+{{ '%.2f'|format(pct) }}%</span>
                        {% elif pct < 0 %}
                            <span style="color:#e74c3c;font-weight:bold;">{{ '%.2f'|format(pct) }}%</span>
                        {% else %}
                            <span style="color:#aaa;">—</span>
                        {% endif %}
                    {% else %}
                        <span style="color:#aaa;">—</span>
                    {% endif %}
                </td>
                <td>{{ "{:,}".format(row.monthly_listeners) }}</td>
            </tr>
            {% endfor %}
        </table>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    const chartLabels = [
        {% for row in results|reverse %}
            "{{ row.date | datetimeformat('short') }}",
        {% endfor %}
    ];
    const chartData = [
        {% for row in results|reverse %}
            {{ row.monthly_listeners }},
        {% endfor %}
    ];
    const ctx = document.getElementById('listenersChart').getContext('2d');
    const gradient = ctx.createLinearGradient(0, 0, 0, 220);
    gradient.addColorStop(0, 'rgba(30,215,96,0.97)');
    gradient.addColorStop(1, 'rgba(25,21,20,0.18)');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartLabels,
            datasets: [{
                label: 'Monthly Listeners',
                data: chartData,
                fill: true,
                backgroundColor: gradient,
                borderColor: '#1DB954',
                borderWidth: 3,
                pointRadius: 3,
                pointBackgroundColor: '#1DB954',
                pointBorderColor: '#fff',
                tension: 0.35,
            }]
        },
        options: {
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Date',
                        color: '#fff',
                        font: { weight: 'bold', size: 16 }
                    },
                    ticks: { color: '#aaa', font: { weight: 'bold' } },
                    grid: { color: 'rgba(29,185,84,0.08)' }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Monthly Listeners',
                        color: '#fff',
                        font: { weight: 'bold', size: 16 }
                    },
                    ticks: { color: '#aaa', font: { weight: 'bold' } },
                    grid: { color: 'rgba(29,185,84,0.08)' }
                }
            }
        }
    });
    </script>
    <style>
    .artist-history-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 1.13em;
        background: transparent;
        margin-top: 32px;
        margin-bottom: 24px;
        box-shadow: 0 2px 16px rgba(0,0,0,0.10);
        border-radius: 14px;
        overflow: hidden;
    }
    .artist-history-table th, .artist-history-table td {
        padding: 14px 10px;
        text-align: left;
    }
    .artist-history-table th {
        background: #232323;
        color: #1DB954;
        font-size: 1.08em;
        letter-spacing: 1px;
        border-bottom: 2px solid #1DB954;
    }
    .artist-history-table tr {
        background: #191414;
        transition: background 0.2s;
    }
    .artist-history-table tr:nth-child(even) {
        background: #232323;
    }
    .artist-history-table tr:hover {
        background: #282828;
    }
    </style>
    {% else %}
    <div style="max-width:700px;margin:60px auto 0 auto;text-align:center;padding:40px 24px;background:#232323;border-radius:18px;box-shadow:0 2px 16px rgba(0,0,0,0.10);color:#fff;">
        <h2>Artist not found or no data available.</h2>
        <p>Please check the artist name or try searching for another artist.</p>
    </div>
    {% endif %}
</div>
{% endblock %}
